<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template-Employee Flow Test (Browser)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        .header h1 {
            color: #333;
            margin: 0;
            font-size: 2.5em;
        }
        .header p {
            color: #666;
            margin: 10px 0 0 0;
            font-size: 1.1em;
        }
        .test-step {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
        }
        .test-step.success {
            border-color: #28a745;
            background: #d4edda;
        }
        .test-step.error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .test-step.warning {
            border-color: #ffc107;
            background: #fff3cd;
        }
        .step-header {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1.1em;
        }
        .test-step.success .step-header {
            background: #28a745;
        }
        .test-step.error .step-header {
            background: #dc3545;
        }
        .test-step.warning .step-header {
            background: #ffc107;
            color: #333;
        }
        .step-content {
            padding: 20px;
        }
        .log-output {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            white-space: pre-wrap;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        button:hover:not(:disabled) {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .results-summary {
            background: #f8f9fa;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            margin: 30px 0;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        .template-preview {
            width: 200px;
            height: 120px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin: 15px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .employee-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            background: white;
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Template-Employee Flow Test</h1>
            <p>Complete end-to-end testing of template creation and employee integration</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
        </div>

        <!-- Step 1: Environment Setup -->
        <div class="test-step" id="step1">
            <div class="step-header">
                Step 1: Environment Setup & Authentication
            </div>
            <div class="step-content">
                <p>Setting up test environment and verifying API connectivity...</p>
                <button onclick="setupEnvironment()">üöÄ Start Test</button>
                <div class="log-output" id="log1"></div>
            </div>
        </div>

        <!-- Step 2: Fetch Departments -->
        <div class="test-step" id="step2">
            <div class="step-header">
                Step 2: Fetch Available Departments
            </div>
            <div class="step-content">
                <p>Fetching departments available for template assignment...</p>
                <button onclick="fetchDepartments()" disabled>üìÅ Fetch Departments</button>
                <div class="log-output" id="log2"></div>
                <div id="departmentsList"></div>
            </div>
        </div>

        <!-- Step 3: Create Template -->
        <div class="test-step" id="step3">
            <div class="step-header">
                Step 3: Create Department Template
            </div>
            <div class="step-content">
                <div class="form-group">
                    <label>Template Name:</label>
                    <input type="text" id="templateName" value="Test Sales Template" />
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="templateDescription" rows="3">A test template for sales department with red color scheme</textarea>
                </div>
                <div class="form-group">
                    <label>Color Scheme:</label>
                    <input type="color" id="templateColor" value="#E63946" />
                </div>
                <div class="form-group">
                    <label>Target Department:</label>
                    <select id="templateDepartment" disabled>
                        <option value="">Select department...</option>
                    </select>
                </div>
                <button onclick="createTemplate()" disabled>üé® Create Template</button>
                <div class="log-output" id="log3"></div>
                <div id="templatePreview"></div>
            </div>
        </div>

        <!-- Step 4: Test Effective Template API -->
        <div class="test-step" id="step4">
            <div class="step-header">
                Step 4: Test Effective Template API
            </div>
            <div class="step-content">
                <p>Testing the API that employee creation uses to fetch templates...</p>
                <button onclick="testEffectiveTemplate()" disabled>üîç Test Template API</button>
                <div class="log-output" id="log4"></div>
            </div>
        </div>

        <!-- Step 5: Create Employee -->
        <div class="test-step" id="step5">
            <div class="step-header">
                Step 5: Create Employee with Template
            </div>
            <div class="step-content">
                <div class="form-group">
                    <label>First Name:</label>
                    <input type="text" id="employeeFirstName" value="John" />
                </div>
                <div class="form-group">
                    <label>Last Name:</label>
                    <input type="text" id="employeeLastName" value="TestUser" />
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="employeeEmail" value="john.testuser@example.com" />
                </div>
                <div class="form-group">
                    <label>Phone:</label>
                    <input type="tel" id="employeePhone" value="+27-87-123-4567" />
                </div>
                <div class="form-group">
                    <label>Position:</label>
                    <input type="text" id="employeePosition" value="Sales Representative" />
                </div>
                <div class="form-group">
                    <label>Department:</label>
                    <select id="employeeDepartment" disabled>
                        <option value="">Select department...</option>
                    </select>
                </div>
                <button onclick="createEmployee()" disabled>üë§ Create Employee</button>
                <div class="log-output" id="log5"></div>
            </div>
        </div>

        <!-- Step 6: Verify Employee Card -->
        <div class="test-step" id="step6">
            <div class="step-header">
                Step 6: Verify Employee Card Template
            </div>
            <div class="step-content">
                <p>Verifying that the employee's business card has the correct template applied...</p>
                <button onclick="verifyEmployeeCard()" disabled>üÉè Verify Card Template</button>
                <div class="log-output" id="log6"></div>
                <div id="employeeCardResult"></div>
            </div>
        </div>

        <!-- Results Summary -->
        <div class="results-summary" id="resultsSummary" style="display: none;">
            <h3>üìä Test Results Summary</h3>
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        // Configuration - These should match your actual frontend configuration
        const getBaseUrl = () => {
            // Use localhost for development (same as your backend)
            return 'http://localhost:8383';
        };

        const API_BASE_URL = getBaseUrl();
        const ENTERPRISE_ID = 'x-spark-test';
        
        // Global variables
        let departments = [];
        let createdTemplateId = null;
        let selectedDepartmentId = null;
        let createdEmployeeId = null;
        let testResults = {};
        let currentStep = 0;

        // Utility functions
        function log(stepId, message, type = 'info') {
            const logElement = document.getElementById(`log${stepId}`);
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${typeIcon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStepStatus(stepId, status) {
            const step = document.getElementById(`step${stepId}`);
            step.className = `test-step ${status}`;
        }

        function enableNextStep(stepId) {
            currentStep = Math.max(currentStep, stepId);
            updateProgress();
            
            const nextStep = stepId + 1;
            if (nextStep <= 6) {
                const buttons = document.querySelectorAll(`#step${nextStep} button`);
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        function updateProgress() {
            const progressBar = document.getElementById('progressBar');
            const progress = (currentStep / 6) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function getAuthHeaders() {
            // Use the current Firebase token from your frontend
            const token = "eyJhbGciOiJSUzI1NiIsImtpZCI6IjJiN2JhZmIyZjEwY2FlMmIxZjA3ZjM4MTZjNTQyMmJlY2NhNWMyMjMiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20veHNjYXJkLWFkZGQ0IiwiYXVkIjoieHNjYXJkLWFkZGQ0IiwiYXV0aF90aW1lIjoxNzU0MzA4MDExLCJ1c2VyX2lkIjoiWDh6aThhdlQ1T2RQSDBsYkNxN3E0ODJmWU91MSIsInN1YiI6Ilg4emk4YXZUNU9kUEgwbGJDcTdxNDgyZllPdTEiLCJpYXQiOjE3NTQzMDgwMTEsImV4cCI6MTc1NDMxMTYxMSwiZW1haWwiOiJ4YXBheWk5NTY3QGNvdXJzb3JhLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJmaXJlYmFzZSI6eyJpZGVudGl0aWVzIjp7ImVtYWlsIjpbInhhcGF5aTk1NjdAY291cnNvcmEuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoicGFzc3dvcmQifX0.Y18knD3unbWKcwhe6NHtpKFPAFhyYyDF3mExgkKG9qYq3WUSD54MyPyfODYxYiVFHvCSJApZEumB9acXPjtkIJ4IPErXkTCUadg72Y9nOffymvYS_4Caf-tyumXOnvyUcZcAqSKAeCIBmkhomfmVYqLmAVkzUpVee2VeYs_Eki3ukIbZCTkTdHktovf634el9WE9Ay-MjjxLcUy2hv1yJBvZXbMS6okVAjkkTCnVq_IOjc-s3di6As05uBUwUXNjRNXCUMjLZu2dX8ZfhhzAdPtfiIgSVKl93_rbj8_xhTPIBPDYZwWN8xMDcriwV0u2eQkusahydJiVUgsR8Sg9ng";
            
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        function buildEnterpriseUrl(endpoint) {
            // Replicate the buildEnterpriseUrl function from your frontend
            return endpoint.replace(':enterpriseId', ENTERPRISE_ID);
        }

        async function makeAPIRequest(endpoint, options = {}) {
            const url = `${API_BASE_URL}${buildEnterpriseUrl(endpoint)}`;
            
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        ...getAuthHeaders(),
                        ...options.headers
                    }
                });
                
                const responseText = await response.text();
                let data;
                
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    data = responseText;
                }
                
                return { response, data, url };
            } catch (error) {
                throw new Error(`Network error: ${error.message}`);
            }
        }

        // Test functions
        async function setupEnvironment() {
            log(1, 'Setting up test environment...');
            
            try {
                // Use the hardcoded token from your frontend
                const token = "eyJhbGciOiJSUzI1NiIsImtpZCI6IjJiN2JhZmIyZjEwY2FlMmIxZjA3ZjM4MTZjNTQyMmJlY2NhNWMyMjMiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20veHNjYXJkLWFkZGQ0IiwiYXVkIjoieHNjYXJkLWFkZGQ0IiwiYXV0aF90aW1lIjoxNzU0MzA4MDExLCJ1c2VyX2lkIjoiWDh6aThhdlQ1T2RQSDBsYkNxN3E0ODJmWU91MSIsInN1YiI6Ilg4emk4YXZUNU9kUEgwbGJDcTdxNDgyZllPdTEiLCJpYXQiOjE3NTQzMDgwMTEsImV4cCI6MTc1NDMxMTYxMSwiZW1haWwiOiJ4YXBheWk5NTY3QGNvdXJzb3JhLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJmaXJlYmFzZSI6eyJpZGVudGl0aWVzIjp7ImVtYWlsIjpbInhhcGF5aTk1NjdAY291cnNvcmEuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoicGFzc3dvcmQifX0.Y18knD3unbWKcwhe6NHtpKFPAFhyYyDF3mExgkKG9qYq3WUSD54MyPyfODYxYiVFHvCSJApZEumB9acXPjtkIJ4IPErXkTCUadg72Y9nOffymvYS_4Caf-tyumXOnvyUcZcAqSKAeCIBmkhomfmVYqLmAVkzUpVee2VeYs_Eki3ukIbZCTkTdHktovf634el9WE9Ay-MjjxLcUy2hv1yJBvZXbMS6okVAjkkTCnVq_IOjc-s3di6As05uBUwUXNjRNXCUMjLZu2dX8ZfhhzAdPtfiIgSVKl93_rbj8_xhTPIBPDYZwWN8xMDcriwV0u2eQkusahydJiVUgsR8Sg9ng";
                
                log(1, `Enterprise ID: ${ENTERPRISE_ID}`, 'info');
                log(1, `API Base URL: ${API_BASE_URL}`, 'info');
                log(1, `Token available: ${token.substring(0, 50)}...`, 'info');
                
                // Test API connectivity with a simple enterprise call
                log(1, 'Testing API connectivity...');
                const { response, data, url } = await makeAPIRequest('/enterprise/:enterpriseId');
                
                log(1, `Test request to: ${url}`);
                log(1, `Response status: ${response.status}`);
                
                if (response.ok) {
                    log(1, 'API connectivity test: SUCCESS', 'success');
                    log(1, `Enterprise data: ${JSON.stringify(data, null, 2)}`, 'info');
                    testResults.apiConnectivity = true;
                } else {
                    log(1, `API connectivity test: FAILED (${response.status})`, 'warning');
                    log(1, `Response: ${JSON.stringify(data, null, 2)}`, 'warning');
                    testResults.apiConnectivity = false;
                }
                
                updateStepStatus(1, 'success');
                enableNextStep(1);
                log(1, 'Environment setup complete!', 'success');
                
            } catch (error) {
                log(1, `Environment setup error: ${error.message}`, 'error');
                updateStepStatus(1, 'error');
                testResults.apiConnectivity = false;
            }
        }

        async function fetchDepartments() {
            log(2, 'Fetching departments...');
            
            try {
                const { response, data, url } = await makeAPIRequest('/enterprise/:enterpriseId/departments');
                
                log(2, `Request URL: ${url}`);
                log(2, `Response status: ${response.status}`);
                log(2, `Response data: ${JSON.stringify(data, null, 2)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${JSON.stringify(data)}`);
                }
                
                if (data.departments && Array.isArray(data.departments)) {
                    departments = data.departments;
                    log(2, `Found ${departments.length} departments`, 'success');
                    
                    // Populate dropdowns
                    const templateSelect = document.getElementById('templateDepartment');
                    const employeeSelect = document.getElementById('employeeDepartment');
                    
                    departments.forEach(dept => {
                        const option1 = new Option(dept.name, dept.id);
                        const option2 = new Option(dept.name, dept.id);
                        templateSelect.add(option1);
                        employeeSelect.add(option2);
                    });
                    
                    templateSelect.disabled = false;
                    employeeSelect.disabled = false;
                    
                    // Display departments
                    const deptList = document.getElementById('departmentsList');
                    deptList.innerHTML = '<h4>Available Departments:</h4>' + 
                        departments.map(dept => `<div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 6px;">
                            <strong>${dept.name}</strong><br>
                            <small>ID: ${dept.id}</small><br>
                            <small>${dept.description || 'No description'}</small>
                        </div>`).join('');
                    
                    updateStepStatus(2, 'success');
                    enableNextStep(2);
                    testResults.departmentsFetch = true;
                } else {
                    throw new Error('Invalid departments response format');
                }
                
            } catch (error) {
                log(2, `Error fetching departments: ${error.message}`, 'error');
                updateStepStatus(2, 'error');
                testResults.departmentsFetch = false;
            }
        }

        async function createTemplate() {
            const name = document.getElementById('templateName').value;
            const description = document.getElementById('templateDescription').value;
            const colorScheme = document.getElementById('templateColor').value;
            const departmentId = document.getElementById('templateDepartment').value;
            
            if (!name || !departmentId) {
                log(3, 'Please fill in template name and select a department', 'error');
                return;
            }
            
            selectedDepartmentId = departmentId;
            log(3, 'Creating template...');
            log(3, `Name: ${name}`);
            log(3, `Department: ${departmentId}`);
            log(3, `Color: ${colorScheme}`);
            
            try {
                const templateData = {
                    name,
                    description,
                    colorScheme,
                    departmentId,
                    enterpriseId: ENTERPRISE_ID,
                    scope: 'department',
                    companyLogo: null
                };
                
                log(3, `Request payload: ${JSON.stringify(templateData, null, 2)}`);
                
                const response = await fetch(`${API_BASE_URL}/api/templates`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(templateData)
                });
                
                log(3, `Response status: ${response.status}`);
                
                const responseText = await response.text();
                log(3, `Response body: ${responseText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${responseText}`);
                }
                
                const result = JSON.parse(responseText);
                
                if (result.success && result.data && result.data.id) {
                    createdTemplateId = result.data.id;
                    log(3, `Template created successfully! ID: ${createdTemplateId}`, 'success');
                    
                    // Show template preview
                    const preview = document.getElementById('templatePreview');
                    preview.innerHTML = `
                        <h4>Template Preview:</h4>
                        <div class="template-preview" style="background-color: ${colorScheme}">
                            ${name}
                        </div>
                        <p><strong>ID:</strong> ${createdTemplateId}</p>
                        <p><strong>Name:</strong> ${result.data.name}</p>
                        <p><strong>Department:</strong> ${departments.find(d => d.id === departmentId)?.name}</p>
                        <p><strong>Color:</strong> ${result.data.colorScheme}</p>
                        <p><strong>Created By:</strong> ${result.data.createdByRole}</p>
                    `;
                    
                    updateStepStatus(3, 'success');
                    enableNextStep(3);
                    testResults.templateCreation = true;
                } else {
                    throw new Error('Invalid template creation response');
                }
                
            } catch (error) {
                log(3, `Error creating template: ${error.message}`, 'error');
                updateStepStatus(3, 'error');
                testResults.templateCreation = false;
            }
        }

        async function testEffectiveTemplate() {
            if (!selectedDepartmentId) {
                log(4, 'No department selected', 'error');
                return;
            }
            
            log(4, `Testing effective template API for department ${selectedDepartmentId}...`);
            
            try {
                const url = `${API_BASE_URL}/api/templates/${ENTERPRISE_ID}/${selectedDepartmentId}/effective`;
                log(4, `Request URL: ${url}`);
                
                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });
                
                log(4, `Response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(4, `Error response: ${errorText}`, 'error');
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                log(4, `Effective template response: ${JSON.stringify(result, null, 2)}`);
                
                if (result.success && result.data && result.data.template) {
                    log(4, 'Effective template API: SUCCESS', 'success');
                    log(4, `Template ID: ${result.data.template.id}`, 'info');
                    log(4, `Color Scheme: ${result.data.template.colorScheme}`, 'info');
                    log(4, `Source: ${result.data.source}`, 'info');
                    
                    updateStepStatus(4, 'success');
                    enableNextStep(4);
                    testResults.effectiveTemplateAPI = true;
                } else if (result.fallback) {
                    log(4, 'Using fallback template (no specific template found)', 'warning');
                    log(4, `Fallback: ${JSON.stringify(result.fallback, null, 2)}`, 'warning');
                    
                    updateStepStatus(4, 'warning');
                    enableNextStep(4);
                    testResults.effectiveTemplateAPI = 'fallback';
                } else {
                    throw new Error('Invalid effective template response');
                }
                
            } catch (error) {
                log(4, `Error testing effective template API: ${error.message}`, 'error');
                updateStepStatus(4, 'error');
                testResults.effectiveTemplateAPI = false;
            }
        }

        async function createEmployee() {
            const firstName = document.getElementById('employeeFirstName').value;
            const lastName = document.getElementById('employeeLastName').value;
            const email = document.getElementById('employeeEmail').value;
            const phone = document.getElementById('employeePhone').value;
            const position = document.getElementById('employeePosition').value;
            const departmentId = document.getElementById('employeeDepartment').value;
            
            if (!firstName || !lastName || !email || !departmentId) {
                log(5, 'Please fill in all required fields', 'error');
                return;
            }
            
            log(5, 'Creating employee...');
            log(5, `Name: ${firstName} ${lastName}`);
            log(5, `Department: ${departmentId}`);
            
            try {
                // First, fetch the effective template (simulating frontend logic)
                log(5, 'Fetching effective template for employee...');
                const templateUrl = `${API_BASE_URL}/api/templates/${ENTERPRISE_ID}/${departmentId}/effective`;
                
                let templateData = {
                    colorScheme: '#1B2B5B',
                    companyLogo: null
                };
                
                try {
                    const templateResponse = await fetch(templateUrl, {
                        headers: getAuthHeaders()
                    });
                    
                    if (templateResponse.ok) {
                        const templateResult = await templateResponse.json();
                        log(5, `Template fetch result: ${JSON.stringify(templateResult, null, 2)}`);
                        
                        if (templateResult.success && templateResult.data && templateResult.data.template) {
                            templateData = {
                                colorScheme: templateResult.data.template.colorScheme,
                                companyLogo: templateResult.data.template.companyLogo,
                                templateId: templateResult.data.template.id,
                                templateName: templateResult.data.template.name,
                                templateSource: templateResult.data.source
                            };
                            log(5, 'Template found and will be applied', 'success');
                        } else if (templateResult.fallback) {
                            templateData = {
                                colorScheme: templateResult.fallback.colorScheme,
                                companyLogo: templateResult.fallback.companyLogo
                            };
                            log(5, 'Using fallback template', 'warning');
                        }
                    } else {
                        log(5, 'Template fetch failed, using defaults', 'warning');
                    }
                } catch (error) {
                    log(5, `Template fetch error: ${error.message}`, 'warning');
                }
                
                // Create employee with template data
                const employeeData = {
                    firstName,
                    lastName,
                    email,
                    phone,
                    position,
                    role: 'employee',
                    template: templateData
                };
                
                log(5, `Employee payload: ${JSON.stringify(employeeData, null, 2)}`);
                
                const { response, data, url } = await makeAPIRequest(`/enterprise/:enterpriseId/departments/${departmentId}/employees`, {
                    method: 'POST',
                    body: JSON.stringify(employeeData)
                });
                
                log(5, `Request URL: ${url}`);
                log(5, `Response status: ${response.status}`);
                log(5, `Response body: ${JSON.stringify(data, null, 2)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${JSON.stringify(data)}`);
                }
                
                if (data.success && data.employee) {
                    createdEmployeeId = data.employee.id;
                    log(5, `Employee created successfully! ID: ${createdEmployeeId}`, 'success');
                    log(5, `User ID: ${data.employee.userId}`, 'info');
                    log(5, `Name: ${data.employee.name} ${data.employee.surname}`, 'info');
                    
                    updateStepStatus(5, 'success');
                    enableNextStep(5);
                    testResults.employeeCreation = true;
                } else {
                    throw new Error('Invalid employee creation response');
                }
                
            } catch (error) {
                log(5, `Error creating employee: ${error.message}`, 'error');
                updateStepStatus(5, 'error');
                testResults.employeeCreation = false;
            }
        }

        async function verifyEmployeeCard() {
            if (!createdEmployeeId) {
                log(6, 'No employee ID to verify', 'error');
                return;
            }
            
            log(6, `Verifying employee card for ID ${createdEmployeeId}...`);
            
            try {
                // Fetch employee's business cards
                const { response, data, url } = await makeAPIRequest(`/enterprise/:enterpriseId/employees/${createdEmployeeId}/cards`);
                
                log(6, `Request URL: ${url}`);
                log(6, `Response status: ${response.status}`);
                log(6, `Employee cards: ${JSON.stringify(data, null, 2)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${JSON.stringify(data)}`);
                }
                
                if (data.cards && data.cards.length > 0) {
                    const card = data.cards[0]; // Get the first card
                    log(6, 'Employee card found!', 'success');
                    
                    // Display card details
                    const cardResult = document.getElementById('employeeCardResult');
                    cardResult.innerHTML = `
                        <h4>Employee Card Details:</h4>
                        <div class="employee-card">
                            <div class="template-preview" style="background-color: ${card.colorScheme}">
                                ${card.name} ${card.surname}
                            </div>
                            <p><strong>Name:</strong> ${card.name} ${card.surname}</p>
                            <p><strong>Email:</strong> ${card.email}</p>
                            <p><strong>Position:</strong> ${card.occupation}</p>
                            <p><strong>Color Scheme:</strong> ${card.colorScheme}</p>
                            <p><strong>Company:</strong> ${card.company}</p>
                            <p><strong>Template ID:</strong> ${card.templateId || 'null'}</p>
                            <p><strong>Template Name:</strong> ${card.templateName || 'null'}</p>
                            <p><strong>Template Source:</strong> ${card.templateSource || 'default'}</p>
                        </div>
                    `;
                    
                    // Check if template was applied correctly
                    if (card.templateId && card.templateId === createdTemplateId) {
                        log(6, 'SUCCESS: Employee card has correct template applied!', 'success');
                        updateStepStatus(6, 'success');
                        testResults.employeeCardVerification = true;
                    } else if (card.templateSource === 'default') {
                        log(6, 'WARNING: Employee card is using default template', 'warning');
                        updateStepStatus(6, 'warning');
                        testResults.employeeCardVerification = 'default';
                    } else {
                        log(6, 'ERROR: Template mismatch or not applied', 'error');
                        updateStepStatus(6, 'error');
                        testResults.employeeCardVerification = false;
                    }
                    
                } else {
                    throw new Error('No cards found for employee');
                }
                
                // Generate final results summary
                generateResultsSummary();
                
            } catch (error) {
                log(6, `Error verifying employee card: ${error.message}`, 'error');
                updateStepStatus(6, 'error');
                testResults.employeeCardVerification = false;
                generateResultsSummary();
            }
        }

        function generateResultsSummary() {
            const summary = document.getElementById('resultsSummary');
            const content = document.getElementById('resultsContent');
            
            const getStatusClass = (result) => {
                if (result === true) return 'status-success';
                if (result === false) return 'status-error';
                return 'status-warning';
            };
            
            const getStatusText = (result) => {
                if (result === true) return '‚úÖ SUCCESS';
                if (result === false) return '‚ùå FAILED';
                if (result === 'fallback' || result === 'default') return '‚ö†Ô∏è WARNING';
                return '‚ùì UNKNOWN';
            };
            
            const testNames = {
                apiConnectivity: 'API Connectivity',
                departmentsFetch: 'Departments Fetch',
                templateCreation: 'Template Creation',
                effectiveTemplateAPI: 'Effective Template API',
                employeeCreation: 'Employee Creation',
                employeeCardVerification: 'Employee Card Template'
            };
            
            content.innerHTML = Object.entries(testResults).map(([test, result]) => 
                `<div class="result-item">
                    <span>${testNames[test] || test}</span>
                    <span class="status-badge ${getStatusClass(result)}">${getStatusText(result)}</span>
                </div>`
            ).join('');
            
            // Overall result
            const overallSuccess = Object.values(testResults).every(result => result === true);
            const hasWarnings = Object.values(testResults).some(result => result === 'fallback' || result === 'default');
            
            let overallClass, overallText;
            if (overallSuccess) {
                overallClass = 'status-success';
                overallText = 'üéâ ALL TESTS PASSED - Template system working correctly!';
            } else if (hasWarnings) {
                overallClass = 'status-warning';
                overallText = '‚ö†Ô∏è PARTIAL SUCCESS - Some issues detected';
            } else {
                overallClass = 'status-error';
                overallText = '‚ùå TESTS FAILED - Template system needs attention';
            }
            
            content.innerHTML += `<div class="result-item" style="border-top: 2px solid #667eea; margin-top: 15px; padding-top: 15px;">
                <strong>Overall Result</strong>
                <span class="status-badge ${overallClass}">${overallText}</span>
            </div>`;
            
            summary.style.display = 'block';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log(1, 'Test suite loaded. Click "Start Test" to begin.');
        });
    </script>
</body>
</html>