<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template-Employee Flow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-header {
            color: #1e40af;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #3b82f6;
            background-color: #f8fafc;
        }
        .step.success {
            border-left-color: #10b981;
            background-color: #f0fdf4;
        }
        .step.error {
            border-left-color: #ef4444;
            background-color: #fef2f2;
        }
        .step.warning {
            border-left-color: #f59e0b;
            background-color: #fffbeb;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .log-output {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .result-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        .template-preview {
            width: 200px;
            height: 120px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin: 10px 0;
        }
        .employee-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üß™ Template-Employee Flow Test Suite</h1>
    
    <div class="test-container">
        <div class="test-header">
            <h2>Step 1: Environment Setup & API Configuration</h2>
        </div>
        <div id="setup-step" class="step">
            <p>Configuring test environment...</p>
            <button onclick="setupEnvironment()">Setup Environment</button>
        </div>
        <div class="log-output" id="setup-log"></div>
    </div>

    <div class="test-container">
        <div class="test-header">
            <h2>Step 2: Fetch Departments</h2>
        </div>
        <div id="departments-step" class="step">
            <p>Fetching available departments for template assignment...</p>
            <button onclick="fetchDepartments()" disabled>Fetch Departments</button>
        </div>
        <div class="log-output" id="departments-log"></div>
        <div id="departments-list"></div>
    </div>

    <div class="test-container">
        <div class="test-header">
            <h2>Step 3: Create Template</h2>
        </div>
        <div id="template-step" class="step">
            <div class="form-group">
                <label>Template Name:</label>
                <input type="text" id="templateName" value="Test Sales Template" />
            </div>
            <div class="form-group">
                <label>Description:</label>
                <textarea id="templateDescription">A test template for sales department with red color scheme</textarea>
            </div>
            <div class="form-group">
                <label>Color Scheme:</label>
                <input type="color" id="templateColor" value="#E63946" />
            </div>
            <div class="form-group">
                <label>Department:</label>
                <select id="templateDepartment" disabled>
                    <option value="">Select department...</option>
                </select>
            </div>
            <button onclick="createTemplate()" disabled>Create Template</button>
        </div>
        <div class="log-output" id="template-log"></div>
        <div id="template-preview"></div>
    </div>

    <div class="test-container">
        <div class="test-header">
            <h2>Step 4: Verify Template Creation</h2>
        </div>
        <div id="verify-template-step" class="step">
            <p>Verifying template was created successfully...</p>
            <button onclick="verifyTemplate()" disabled>Verify Template</button>
        </div>
        <div class="log-output" id="verify-template-log"></div>
    </div>

    <div class="test-container">
        <div class="test-header">
            <h2>Step 5: Test Template Fetching (Effective Template API)</h2>
        </div>
        <div id="fetch-template-step" class="step">
            <p>Testing the effective template API that employee creation uses...</p>
            <button onclick="testEffectiveTemplate()" disabled>Test Effective Template API</button>
        </div>
        <div class="log-output" id="fetch-template-log"></div>
    </div>

    <div class="test-container">
        <div class="test-header">
            <h2>Step 6: Create Employee with Template</h2>
        </div>
        <div id="employee-step" class="step">
            <div class="form-group">
                <label>First Name:</label>
                <input type="text" id="employeeFirstName" value="John" />
            </div>
            <div class="form-group">
                <label>Last Name:</label>
                <input type="text" id="employeeLastName" value="TestUser" />
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="employeeEmail" value="john.testuser@example.com" />
            </div>
            <div class="form-group">
                <label>Phone:</label>
                <input type="tel" id="employeePhone" value="+27-87-123-4567" />
            </div>
            <div class="form-group">
                <label>Position:</label>
                <input type="text" id="employeePosition" value="Sales Representative" />
            </div>
            <div class="form-group">
                <label>Department:</label>
                <select id="employeeDepartment" disabled>
                    <option value="">Select department...</option>
                </select>
            </div>
            <button onclick="createEmployee()" disabled>Create Employee</button>
        </div>
        <div class="log-output" id="employee-log"></div>
    </div>

    <div class="test-container">
        <div class="test-header">
            <h2>Step 7: Verify Employee Card Template</h2>
        </div>
        <div id="verify-employee-step" class="step">
            <p>Verifying employee was created with correct template...</p>
            <button onclick="verifyEmployeeCard()" disabled>Verify Employee Card</button>
        </div>
        <div class="log-output" id="verify-employee-log"></div>
        <div id="employee-card-result"></div>
    </div>

    <div class="test-container">
        <div class="test-header">
            <h2>üìä Test Results Summary</h2>
        </div>
        <div id="results-summary" class="results-grid">
            <!-- Results will be populated here -->
        </div>
    </div>

    <script>
        // Global variables
        let API_BASE_URL = 'https://xs-backend-qkza.onrender.com';
        let FIREBASE_TOKEN = 'eyJhbGciOiJSUzI1NiIsImtpZCI6IjU4ZGQxN2Y4NjgyMmY0MjU3ZmJmYzUzNDQ0MmE2MjFiMzVjMGFiNGQiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20veHMtY2FyZCIsImF1ZCI6InhzLWNhcmQiLCJhdXRoX3RpbWUiOjE3MzU5ODM0NTQsInVzZXJfaWQiOiJBaTlHejdvWGF2VjlVYkNKSUYwdGlzMWVLWk8yIiwic3ViIjoiQWk5R3o3b1hhblY5VWJDSklGMHRpczFlS1pPMiIsImlhdCI6MTczNTk4MzQ1NCwiZXhwIjoxNzM1OTg3MDU0LCJlbWFpbCI6InB1bGVAeC1zcGFyay5jb20iLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsImZpcmViYXNlIjp7ImlkZW50aXRpZXMiOnsiZW1haWwiOlsicHVsZUB4LXNwYXJrLmNvbSJdfSwic2lnbl9pbl9wcm92aWRlciI6InBhc3N3b3JkIn19.F4S2f7GZLhBOyOLRPOPnqxNGEWTB_3QqJKUy_IwBY5g8nzCCBxZqWzJfCcZ5vDxIg8Vv2jFEUPOzqwCLYJT8TLRa0uHD9Qv8t6Hq5r4YwTQw4zFVsLUz4oWxVyJ5J8H2k9Vv7R2Dj6G8f5Xz3Yq1Wv0P9M4N7K8Lz2Hy5Uz6Cv8Bw';
        let ENTERPRISE_ID = 'x-spark-test';
        
        let createdTemplateId = null;
        let selectedDepartmentId = null;
        let createdEmployeeId = null;
        let departments = [];
        let testResults = {};

        // Utility functions
        function log(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logElement.innerHTML += `[${timestamp}] ${typeIcon} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStepStatus(stepId, status) {
            const step = document.getElementById(stepId);
            step.className = `step ${status}`;
        }

        function enableButton(buttonText, parentId) {
            const buttons = document.querySelectorAll(`#${parentId} button`);
            buttons.forEach(btn => {
                if (btn.textContent === buttonText) {
                    btn.disabled = false;
                }
            });
        }

        // Test functions
        async function setupEnvironment() {
            log('setup-log', 'Setting up test environment...');
            
            // Set localStorage values
            localStorage.setItem('enterpriseId', ENTERPRISE_ID);
            localStorage.setItem('firebaseToken', FIREBASE_TOKEN);
            
            log('setup-log', `Enterprise ID: ${ENTERPRISE_ID}`, 'info');
            log('setup-log', `API Base URL: ${API_BASE_URL}`, 'info');
            log('setup-log', `Firebase Token: ${FIREBASE_TOKEN.substring(0, 50)}...`, 'info');
            
            // Test API connectivity
            try {
                const response = await fetch(`${API_BASE_URL}/health`, {
                    headers: {
                        'Authorization': `Bearer ${FIREBASE_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    log('setup-log', 'API connectivity test: SUCCESS', 'success');
                    testResults.apiConnectivity = true;
                } else {
                    log('setup-log', `API connectivity test: FAILED (${response.status})`, 'warning');
                    testResults.apiConnectivity = false;
                }
            } catch (error) {
                log('setup-log', `API connectivity test: ERROR - ${error.message}`, 'error');
                testResults.apiConnectivity = false;
            }
            
            updateStepStatus('setup-step', 'success');
            enableButton('Fetch Departments', 'departments-step');
            log('setup-log', 'Environment setup complete!', 'success');
        }

        async function fetchDepartments() {
            log('departments-log', 'Fetching departments...');
            
            try {
                const url = `${API_BASE_URL}/api/enterprise/${ENTERPRISE_ID}/departments`;
                log('departments-log', `Request URL: ${url}`);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${FIREBASE_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log('departments-log', `Response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log('departments-log', `Response data: ${JSON.stringify(data, null, 2)}`);
                
                if (data.departments && Array.isArray(data.departments)) {
                    departments = data.departments;
                    log('departments-log', `Found ${departments.length} departments`, 'success');
                    
                    // Populate department dropdowns
                    const templateDeptSelect = document.getElementById('templateDepartment');
                    const employeeDeptSelect = document.getElementById('employeeDepartment');
                    
                    departments.forEach(dept => {
                        const option1 = new Option(dept.name, dept.id);
                        const option2 = new Option(dept.name, dept.id);
                        templateDeptSelect.add(option1);
                        employeeDeptSelect.add(option2);
                    });
                    
                    templateDeptSelect.disabled = false;
                    employeeDeptSelect.disabled = false;
                    
                    // Display departments
                    const deptList = document.getElementById('departments-list');
                    deptList.innerHTML = '<h4>Available Departments:</h4>' + 
                        departments.map(dept => `<div class="result-card">
                            <strong>${dept.name}</strong><br>
                            ID: ${dept.id}<br>
                            ${dept.description || 'No description'}
                        </div>`).join('');
                    
                    updateStepStatus('departments-step', 'success');
                    enableButton('Create Template', 'template-step');
                    testResults.departmentsFetch = true;
                } else {
                    throw new Error('Invalid departments response format');
                }
                
            } catch (error) {
                log('departments-log', `Error fetching departments: ${error.message}`, 'error');
                updateStepStatus('departments-step', 'error');
                testResults.departmentsFetch = false;
            }
        }

        async function createTemplate() {
            const name = document.getElementById('templateName').value;
            const description = document.getElementById('templateDescription').value;
            const colorScheme = document.getElementById('templateColor').value;
            const departmentId = document.getElementById('templateDepartment').value;
            
            if (!name || !departmentId) {
                log('template-log', 'Please fill in template name and select a department', 'error');
                return;
            }
            
            selectedDepartmentId = departmentId;
            log('template-log', 'Creating template...');
            log('template-log', `Name: ${name}`);
            log('template-log', `Department: ${departmentId}`);
            log('template-log', `Color: ${colorScheme}`);
            
            try {
                const templateData = {
                    name,
                    description,
                    colorScheme,
                    departmentId,
                    enterpriseId: ENTERPRISE_ID,
                    scope: 'department',
                    companyLogo: null
                };
                
                log('template-log', `Request payload: ${JSON.stringify(templateData, null, 2)}`);
                
                const response = await fetch(`${API_BASE_URL}/api/templates`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${FIREBASE_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });
                
                log('template-log', `Response status: ${response.status}`);
                
                const responseText = await response.text();
                log('template-log', `Response body: ${responseText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${responseText}`);
                }
                
                const result = JSON.parse(responseText);
                
                if (result.success && result.data && result.data.template) {
                    createdTemplateId = result.data.template.id;
                    log('template-log', `Template created successfully! ID: ${createdTemplateId}`, 'success');
                    
                    // Show template preview
                    const preview = document.getElementById('template-preview');
                    preview.innerHTML = `
                        <h4>Template Preview:</h4>
                        <div class="template-preview" style="background-color: ${colorScheme}">
                            ${name}
                        </div>
                        <p><strong>ID:</strong> ${createdTemplateId}</p>
                        <p><strong>Department:</strong> ${departments.find(d => d.id === departmentId)?.name}</p>
                    `;
                    
                    updateStepStatus('template-step', 'success');
                    enableButton('Verify Template', 'verify-template-step');
                    testResults.templateCreation = true;
                } else {
                    throw new Error('Invalid template creation response');
                }
                
            } catch (error) {
                log('template-log', `Error creating template: ${error.message}`, 'error');
                updateStepStatus('template-step', 'error');
                testResults.templateCreation = false;
            }
        }

        async function verifyTemplate() {
            if (!createdTemplateId) {
                log('verify-template-log', 'No template ID to verify', 'error');
                return;
            }
            
            log('verify-template-log', `Verifying template ${createdTemplateId}...`);
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/templates/template/${createdTemplateId}`, {
                    headers: {
                        'Authorization': `Bearer ${FIREBASE_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log('verify-template-log', `Response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                log('verify-template-log', `Template verification: ${JSON.stringify(result, null, 2)}`);
                
                if (result.success && result.data && result.data.template) {
                    log('verify-template-log', 'Template verification: SUCCESS', 'success');
                    updateStepStatus('verify-template-step', 'success');
                    enableButton('Test Effective Template API', 'fetch-template-step');
                    testResults.templateVerification = true;
                } else {
                    throw new Error('Template not found or invalid response');
                }
                
            } catch (error) {
                log('verify-template-log', `Error verifying template: ${error.message}`, 'error');
                updateStepStatus('verify-template-step', 'error');
                testResults.templateVerification = false;
            }
        }

        async function testEffectiveTemplate() {
            if (!selectedDepartmentId) {
                log('fetch-template-log', 'No department selected', 'error');
                return;
            }
            
            log('fetch-template-log', `Testing effective template API for department ${selectedDepartmentId}...`);
            
            try {
                const url = `${API_BASE_URL}/api/templates/${ENTERPRISE_ID}/${selectedDepartmentId}/effective`;
                log('fetch-template-log', `Request URL: ${url}`);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${FIREBASE_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log('fetch-template-log', `Response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log('fetch-template-log', `Error response: ${errorText}`, 'error');
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                log('fetch-template-log', `Effective template response: ${JSON.stringify(result, null, 2)}`);
                
                if (result.success && result.data && result.data.template) {
                    log('fetch-template-log', 'Effective template API: SUCCESS', 'success');
                    log('fetch-template-log', `Template ID: ${result.data.template.id}`, 'info');
                    log('fetch-template-log', `Color Scheme: ${result.data.template.colorScheme}`, 'info');
                    log('fetch-template-log', `Source: ${result.data.source}`, 'info');
                    
                    updateStepStatus('fetch-template-step', 'success');
                    enableButton('Create Employee', 'employee-step');
                    testResults.effectiveTemplateAPI = true;
                } else if (result.fallback) {
                    log('fetch-template-log', 'Using fallback template (no specific template found)', 'warning');
                    log('fetch-template-log', `Fallback: ${JSON.stringify(result.fallback, null, 2)}`);
                    
                    updateStepStatus('fetch-template-step', 'warning');
                    enableButton('Create Employee', 'employee-step');
                    testResults.effectiveTemplateAPI = 'fallback';
                } else {
                    throw new Error('Invalid effective template response');
                }
                
            } catch (error) {
                log('fetch-template-log', `Error testing effective template API: ${error.message}`, 'error');
                updateStepStatus('fetch-template-step', 'error');
                testResults.effectiveTemplateAPI = false;
            }
        }

        async function createEmployee() {
            const firstName = document.getElementById('employeeFirstName').value;
            const lastName = document.getElementById('employeeLastName').value;
            const email = document.getElementById('employeeEmail').value;
            const phone = document.getElementById('employeePhone').value;
            const position = document.getElementById('employeePosition').value;
            const departmentId = document.getElementById('employeeDepartment').value;
            
            if (!firstName || !lastName || !email || !departmentId) {
                log('employee-log', 'Please fill in all required fields', 'error');
                return;
            }
            
            log('employee-log', 'Creating employee...');
            log('employee-log', `Name: ${firstName} ${lastName}`);
            log('employee-log', `Department: ${departmentId}`);
            
            try {
                // First, fetch the effective template (simulating frontend logic)
                log('employee-log', 'Fetching effective template for employee...');
                const templateUrl = `${API_BASE_URL}/api/templates/${ENTERPRISE_ID}/${departmentId}/effective`;
                
                const templateResponse = await fetch(templateUrl, {
                    headers: {
                        'Authorization': `Bearer ${FIREBASE_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                let templateData = {
                    colorScheme: '#1B2B5B',
                    companyLogo: null
                };
                
                if (templateResponse.ok) {
                    const templateResult = await templateResponse.json();
                    log('employee-log', `Template fetch result: ${JSON.stringify(templateResult, null, 2)}`);
                    
                    if (templateResult.success && templateResult.data && templateResult.data.template) {
                        templateData = {
                            colorScheme: templateResult.data.template.colorScheme,
                            companyLogo: templateResult.data.template.companyLogo,
                            templateId: templateResult.data.template.id,
                            templateName: templateResult.data.template.name,
                            templateSource: templateResult.data.source
                        };
                        log('employee-log', 'Template found and will be applied', 'success');
                    } else if (templateResult.fallback) {
                        templateData = {
                            colorScheme: templateResult.fallback.colorScheme,
                            companyLogo: templateResult.fallback.companyLogo
                        };
                        log('employee-log', 'Using fallback template', 'warning');
                    }
                } else {
                    log('employee-log', 'Template fetch failed, using defaults', 'warning');
                }
                
                // Create employee with template data
                const employeeData = {
                    firstName,
                    lastName,
                    email,
                    phone,
                    position,
                    role: 'employee',
                    template: templateData
                };
                
                log('employee-log', `Employee payload: ${JSON.stringify(employeeData, null, 2)}`);
                
                const url = `${API_BASE_URL}/api/enterprise/${ENTERPRISE_ID}/departments/${departmentId}/employees`;
                log('employee-log', `Request URL: ${url}`);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${FIREBASE_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(employeeData)
                });
                
                log('employee-log', `Response status: ${response.status}`);
                
                const responseText = await response.text();
                log('employee-log', `Response body: ${responseText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${responseText}`);
                }
                
                const result = JSON.parse(responseText);
                
                if (result.success && result.data && result.data.employee) {
                    createdEmployeeId = result.data.employee.id;
                    log('employee-log', `Employee created successfully! ID: ${createdEmployeeId}`, 'success');
                    
                    updateStepStatus('employee-step', 'success');
                    enableButton('Verify Employee Card', 'verify-employee-step');
                    testResults.employeeCreation = true;
                } else {
                    throw new Error('Invalid employee creation response');
                }
                
            } catch (error) {
                log('employee-log', `Error creating employee: ${error.message}`, 'error');
                updateStepStatus('employee-step', 'error');
                testResults.employeeCreation = false;
            }
        }

        async function verifyEmployeeCard() {
            if (!createdEmployeeId) {
                log('verify-employee-log', 'No employee ID to verify', 'error');
                return;
            }
            
            log('verify-employee-log', `Verifying employee card for ID ${createdEmployeeId}...`);
            
            try {
                // Fetch employee's business cards
                const url = `${API_BASE_URL}/api/enterprise/${ENTERPRISE_ID}/employees/${createdEmployeeId}/cards`;
                log('verify-employee-log', `Request URL: ${url}`);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${FIREBASE_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log('verify-employee-log', `Response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                log('verify-employee-log', `Employee cards: ${JSON.stringify(result, null, 2)}`);
                
                if (result.cards && result.cards.length > 0) {
                    const card = result.cards[0]; // Get the first card
                    log('verify-employee-log', 'Employee card found!', 'success');
                    
                    // Display card details
                    const cardResult = document.getElementById('employee-card-result');
                    cardResult.innerHTML = `
                        <h4>Employee Card Details:</h4>
                        <div class="employee-card">
                            <div class="template-preview" style="background-color: ${card.colorScheme}">
                                ${card.name} ${card.surname}
                            </div>
                            <p><strong>Name:</strong> ${card.name} ${card.surname}</p>
                            <p><strong>Email:</strong> ${card.email}</p>
                            <p><strong>Position:</strong> ${card.occupation}</p>
                            <p><strong>Color Scheme:</strong> ${card.colorScheme}</p>
                            <p><strong>Company:</strong> ${card.company}</p>
                            <p><strong>Template ID:</strong> ${card.templateId || 'null'}</p>
                            <p><strong>Template Name:</strong> ${card.templateName || 'null'}</p>
                            <p><strong>Template Source:</strong> ${card.templateSource || 'default'}</p>
                        </div>
                    `;
                    
                    // Check if template was applied correctly
                    if (card.templateId && card.templateId === createdTemplateId) {
                        log('verify-employee-log', 'SUCCESS: Employee card has correct template applied!', 'success');
                        updateStepStatus('verify-employee-step', 'success');
                        testResults.employeeCardVerification = true;
                    } else if (card.templateSource === 'default') {
                        log('verify-employee-log', 'WARNING: Employee card is using default template', 'warning');
                        updateStepStatus('verify-employee-step', 'warning');
                        testResults.employeeCardVerification = 'default';
                    } else {
                        log('verify-employee-log', 'ERROR: Template mismatch or not applied', 'error');
                        updateStepStatus('verify-employee-step', 'error');
                        testResults.employeeCardVerification = false;
                    }
                    
                } else {
                    throw new Error('No cards found for employee');
                }
                
                // Generate final results summary
                generateResultsSummary();
                
            } catch (error) {
                log('verify-employee-log', `Error verifying employee card: ${error.message}`, 'error');
                updateStepStatus('verify-employee-step', 'error');
                testResults.employeeCardVerification = false;
                generateResultsSummary();
            }
        }

        function generateResultsSummary() {
            const summary = document.getElementById('results-summary');
            
            const getStatusIcon = (result) => {
                if (result === true) return '‚úÖ';
                if (result === false) return '‚ùå';
                if (result === 'fallback' || result === 'default') return '‚ö†Ô∏è';
                return '‚ùì';
            };
            
            const getStatusText = (result) => {
                if (result === true) return 'SUCCESS';
                if (result === false) return 'FAILED';
                if (result === 'fallback') return 'FALLBACK';
                if (result === 'default') return 'DEFAULT';
                return 'UNKNOWN';
            };
            
            summary.innerHTML = `
                <div class="result-card">
                    <h4>API Connectivity</h4>
                    <p>${getStatusIcon(testResults.apiConnectivity)} ${getStatusText(testResults.apiConnectivity)}</p>
                </div>
                <div class="result-card">
                    <h4>Departments Fetch</h4>
                    <p>${getStatusIcon(testResults.departmentsFetch)} ${getStatusText(testResults.departmentsFetch)}</p>
                </div>
                <div class="result-card">
                    <h4>Template Creation</h4>
                    <p>${getStatusIcon(testResults.templateCreation)} ${getStatusText(testResults.templateCreation)}</p>
                </div>
                <div class="result-card">
                    <h4>Template Verification</h4>
                    <p>${getStatusIcon(testResults.templateVerification)} ${getStatusText(testResults.templateVerification)}</p>
                </div>
                <div class="result-card">
                    <h4>Effective Template API</h4>
                    <p>${getStatusIcon(testResults.effectiveTemplateAPI)} ${getStatusText(testResults.effectiveTemplateAPI)}</p>
                </div>
                <div class="result-card">
                    <h4>Employee Creation</h4>
                    <p>${getStatusIcon(testResults.employeeCreation)} ${getStatusText(testResults.employeeCreation)}</p>
                </div>
                <div class="result-card">
                    <h4>Employee Card Template</h4>
                    <p>${getStatusIcon(testResults.employeeCardVerification)} ${getStatusText(testResults.employeeCardVerification)}</p>
                </div>
            `;
            
            // Overall result
            const overallSuccess = Object.values(testResults).every(result => result === true);
            const hasWarnings = Object.values(testResults).some(result => result === 'fallback' || result === 'default');
            
            if (overallSuccess) {
                summary.innerHTML += `<div class="result-card" style="border-color: #10b981; background-color: #f0fdf4;">
                    <h4>üéâ Overall Result</h4>
                    <p>‚úÖ ALL TESTS PASSED - Template system working correctly!</p>
                </div>`;
            } else if (hasWarnings) {
                summary.innerHTML += `<div class="result-card" style="border-color: #f59e0b; background-color: #fffbeb;">
                    <h4>‚ö†Ô∏è Overall Result</h4>
                    <p>‚ö†Ô∏è PARTIAL SUCCESS - Some issues detected</p>
                </div>`;
            } else {
                summary.innerHTML += `<div class="result-card" style="border-color: #ef4444; background-color: #fef2f2;">
                    <h4>‚ùå Overall Result</h4>
                    <p>‚ùå TESTS FAILED - Template system needs attention</p>
                </div>`;
            }
        }
    </script>
</body>
</html>