<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice PDF Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
            display: block;
            width: 100%;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .status.success {
            background: #f0f9ff;
            border-color: #059669;
            color: #065f46;
        }
        .status.error {
            background: #fef2f2;
            border-color: #dc2626;
            color: #991b1b;
        }
        .status.info {
            background: #f0f9ff;
            border-color: #3b82f6;
            color: #1e40af;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Invoice PDF Functionality Test</h1>
        <p>This test will verify that the invoice PDF generation works correctly with populated data.</p>
        
        <button class="test-button" onclick="testInvoiceData()">1. Test Invoice Data Loading</button>
        <button class="test-button" onclick="testPDFGeneration()">2. Test PDF Generation</button>
        <button class="test-button" onclick="downloadTestPDF()">3. Download Test PDF</button>
        
        <div id="status"></div>
        <div id="results" class="results" style="display: none;"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8383';
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function showResults(data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = JSON.stringify(data, null, 2);
        }
        
        async function testInvoiceData() {
            showStatus('üîÑ Testing invoice data loading...', 'info');
            
            try {
                // Simulate the billing service call
                const response = await fetch(`${API_BASE_URL}/billing/invoices`, {
                    headers: {
                        'Authorization': 'Bearer test-token',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Using fallback mock data (expected in development)');
                }
                
                const data = await response.json();
                showStatus('‚úÖ Invoice data loaded successfully!', 'success');
                showResults(data);
                
            } catch (error) {
                showStatus('‚ö†Ô∏è Using fallback mock data (this is normal in development)', 'info');
                
                // Show the mock data structure
                const mockData = {
                    invoices: [
                        {
                            id: 'inv_premium_001',
                            number: 'XSC-2025-001',
                            amount: 159.99,
                            total: 159.99,
                            subtotal: 139.12,
                            tax: 20.87,
                            status: 'paid',
                            customerName: 'Acme Business Solutions (Pty) Ltd',
                            customerEmail: 'billing@acmebusiness.co.za',
                            lineItems: [
                                {
                                    description: 'XSCard Premium Subscription - Monthly Plan',
                                    quantity: 1,
                                    rate: 139.12,
                                    amount: 139.12
                                }
                            ]
                        }
                    ]
                };
                showResults(mockData);
            }
        }
        
        async function testPDFGeneration() {
            showStatus('üîÑ Testing PDF generation...', 'info');
            
            try {
                // Test the PDF generation logic
                const testInvoice = {
                    id: 'inv_premium_001',
                    number: 'XSC-2025-001',
                    date: new Date().toISOString(),
                    dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                    amount: 159.99,
                    total: 159.99,
                    subtotal: 139.12,
                    tax: 20.87,
                    currency: 'ZAR',
                    status: 'paid',
                    customerName: 'Acme Business Solutions (Pty) Ltd',
                    customerEmail: 'billing@acmebusiness.co.za',
                    lineItems: [
                        {
                            description: 'XSCard Premium Subscription - Monthly Plan',
                            quantity: 1,
                            rate: 139.12,
                            amount: 139.12
                        }
                    ]
                };
                
                showStatus('‚úÖ PDF generation test completed! Data is properly structured.', 'success');
                showResults({
                    message: 'Invoice data is properly structured for PDF generation',
                    invoice: testInvoice,
                    lineItemsCount: testInvoice.lineItems.length,
                    totalCalculated: testInvoice.subtotal + testInvoice.tax,
                    isDataValid: true
                });
                
            } catch (error) {
                showStatus(`‚ùå PDF generation test failed: ${error.message}`, 'error');
                showResults({ error: error.message });
            }
        }
        
        async function downloadTestPDF() {
            showStatus('üîÑ Creating and downloading test PDF...', 'info');
            
            try {
                // Create HTML content that matches the in-app styling
                const invoice = {
                    id: 'inv_premium_001',
                    number: 'XSC-2025-001',
                    date: new Date().toISOString(),
                    dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                    amount: 159.99,
                    total: 159.99,
                    subtotal: 139.12,
                    tax: 20.87,
                    currency: 'ZAR',
                    status: 'paid',
                    customerName: 'Acme Business Solutions (Pty) Ltd',
                    customerEmail: 'billing@acmebusiness.co.za',
                    lineItems: [
                        {
                            description: 'XSCard Premium Subscription - Monthly Plan',
                            quantity: 1,
                            rate: 139.12,
                            amount: 139.12
                        }
                    ]
                };
                
                const htmlContent = generateInvoiceHTML(invoice);
                const blob = new Blob([htmlContent], { type: 'text/html' });
                
                // Create download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `invoice-${invoice.number}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus('‚úÖ Test PDF (HTML) downloaded successfully! Open it to see the styling.', 'success');
                showResults({
                    message: 'Invoice HTML generated and downloaded',
                    filename: `invoice-${invoice.number}.html`,
                    size: blob.size + ' bytes',
                    note: 'Open the downloaded HTML file to see the styled invoice'
                });
                
            } catch (error) {
                showStatus(`‚ùå PDF download failed: ${error.message}`, 'error');
                showResults({ error: error.message });
            }
        }
        
        function generateInvoiceHTML(invoice) {
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Invoice ${invoice.number}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: white; color: #1f2937; line-height: 1.6; padding: 40px;
        }
        .invoice-container {
            max-width: 800px; margin: 0 auto; background: white;
            border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); overflow: hidden;
        }
        .invoice-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 32px 32px 24px; border-bottom: 1px solid #e5e7eb;
        }
        .company-info h1 { color: #3b82f6; font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .company-info p { color: #6b7280; font-size: 14px; }
        .invoice-title-section { text-align: right; }
        .invoice-title { color: #3b82f6; font-size: 32px; font-weight: 700; margin-bottom: 8px; }
        .invoice-number { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .invoice-dates { font-size: 14px; color: #6b7280; margin-bottom: 8px; }
        .status-badge {
            background: #3b82f6; color: white; padding: 4px 12px; border-radius: 16px;
            font-size: 12px; font-weight: 600; display: inline-block;
        }
        .invoice-details { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; padding: 24px 32px; }
        .bill-to h3, .payment-info h3 { font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px; }
        .customer-name { font-weight: 600; margin-bottom: 4px; }
        .customer-email { color: #3b82f6; margin-bottom: 4px; }
        .customer-details { color: #6b7280; font-size: 14px; }
        .payment-info-grid { display: grid; gap: 8px; }
        .payment-row { display: flex; justify-content: space-between; font-size: 14px; }
        .payment-label { color: #6b7280; }
        .payment-value { font-weight: 500; }
        .payment-status { color: #059669; font-weight: 600; }
        .service-details { padding: 0 32px 32px; }
        .service-details h3 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
        .invoice-table { width: 100%; border-collapse: collapse; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .table-header { background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .table-header th {
            padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #374151;
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        .table-row { border-bottom: 1px solid #f3f4f6; }
        .table-row:nth-child(even) { background: #f9fafb; }
        .table-row td { padding: 16px 12px; font-size: 14px; }
        .description { font-weight: 500; }
        .amount-column { text-align: right; font-weight: 500; }
        .summary-section { margin-top: 24px; display: flex; justify-content: flex-end; }
        .summary-grid { min-width: 240px; }
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; }
        .summary-row.total {
            border-top: 1px solid #e5e7eb; margin-top: 8px; padding-top: 12px;
            font-weight: 700; font-size: 16px;
        }
        .footer { text-align: center; padding: 24px 32px; border-top: 1px solid #e5e7eb; background: #f9fafb; }
        .footer h4 { color: #3b82f6; font-size: 16px; margin-bottom: 8px; }
        .footer p { color: #6b7280; font-size: 14px; }
    </style>
</head>
<body>
    <div class="invoice-container">
        <div class="invoice-header">
            <div class="company-info">
                <h1>XSCard Business Solutions</h1>
                <p>Professional Digital Business Cards & Contact Management</p>
            </div>
            <div class="invoice-title-section">
                <div class="invoice-title">INVOICE</div>
                <div class="invoice-number">${invoice.number}</div>
                <div class="invoice-dates">
                    <div>Issue Date: ${new Date(invoice.date).toLocaleDateString('en-US', { 
                        year: 'numeric', month: 'long', day: 'numeric' 
                    })}</div>
                    <div>Due Date: ${new Date(invoice.dueDate).toLocaleDateString('en-US', { 
                        year: 'numeric', month: 'long', day: 'numeric' 
                    })}</div>
                </div>
                <div class="status-badge">${invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1)}</div>
            </div>
        </div>
        
        <div class="invoice-details">
            <div class="bill-to">
                <h3>Bill To:</h3>
                <div class="customer-name">${invoice.customerName}</div>
                <div class="customer-email">${invoice.customerEmail}</div>
                <div class="customer-details">Professional Business Client</div>
                <div class="customer-details">Cape Town, South Africa</div>
            </div>
            
            <div class="payment-info">
                <h3>Payment Information:</h3>
                <div class="payment-info-grid">
                    <div class="payment-row">
                        <span class="payment-label">Amount:</span>
                        <span class="payment-value">R ${invoice.total.toFixed(2)}</span>
                    </div>
                    <div class="payment-row">
                        <span class="payment-label">Status:</span>
                        <span class="payment-status">${invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1)}</span>
                    </div>
                    <div class="payment-row">
                        <span class="payment-label">Currency:</span>
                        <span class="payment-value">${invoice.currency}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="service-details">
            <h3>Service Details</h3>
            <table class="invoice-table">
                <thead class="table-header">
                    <tr>
                        <th>DESCRIPTION</th>
                        <th style="text-align: center;">QTY</th>
                        <th style="text-align: right;">RATE</th>
                        <th style="text-align: right;">AMOUNT</th>
                    </tr>
                </thead>
                <tbody>
                    ${invoice.lineItems.map(item => `
                        <tr class="table-row">
                            <td class="description">${item.description}</td>
                            <td style="text-align: center;">${item.quantity}</td>
                            <td class="amount-column">R ${item.rate.toFixed(2)}</td>
                            <td class="amount-column">R ${item.amount.toFixed(2)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            
            <div class="summary-section">
                <div class="summary-grid">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span>R ${invoice.subtotal.toFixed(2)}</span>
                    </div>
                    <div class="summary-row">
                        <span>VAT (15%):</span>
                        <span>R ${invoice.tax.toFixed(2)}</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total Amount:</span>
                        <span>R ${invoice.total.toFixed(2)}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <h4>Thank you for choosing XSCard Business Solutions!</h4>
            <p>For support and inquiries, contact us at support@xscard.com</p>
        </div>
    </div>
</body>
</html>`;
        }
    </script>
</body>
</html>
