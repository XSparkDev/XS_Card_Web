<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Alerts Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #f9fafb;
        }
        .debug-button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .debug-button:hover {
            background-color: #2563eb;
        }
        .debug-button.danger {
            background-color: #ef4444;
        }
        .debug-button.danger:hover {
            background-color: #dc2626;
        }
        .debug-button.success {
            background-color: #10b981;
        }
        .debug-button.success:hover {
            background-color: #059669;
        }
        .log-container {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-entry.info { color: #60a5fa; }
        .log-entry.success { color: #34d399; }
        .log-entry.error { color: #f87171; }
        .log-entry.warning { color: #fbbf24; }
        .filter-test {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .filter-controls select {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
        }
        .alert-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 10px;
            background-color: white;
        }
        .alert-item {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            border-left: 4px solid;
            background-color: #f8fafc;
        }
        .alert-item.active { border-left-color: #ef4444; }
        .alert-item.acknowledged { border-left-color: #f59e0b; }
        .alert-item.resolved { border-left-color: #10b981; }
        .alert-item .alert-id { font-weight: bold; }
        .alert-item .alert-status { font-size: 11px; color: #6b7280; }
    </style>
</head>
<body>
    <div class="debug-container">
        <div class="debug-header">
            <h1>üîí Security Alerts Debug Test</h1>
            <p>Comprehensive debugging for Security Alerts filtering issues</p>
        </div>

        <div class="debug-section">
            <h3>üß™ API Tests</h3>
            <button class="debug-button" onclick="testBackendConnection()">Test Backend Connection</button>
            <button class="debug-button" onclick="fetchAllAlerts()">Fetch All Alerts</button>
            <button class="debug-button success" onclick="testAcknowledgeFirst()">Acknowledge First Alert</button>
            <button class="debug-button success" onclick="testResolveFirst()">Resolve First Alert</button>
            <button class="debug-button danger" onclick="clearLogs()">Clear Logs</button>
        </div>

        <div class="debug-section">
            <h3>üîç Filter Testing</h3>
            <div class="filter-test">
                <div>
                    <h4>Frontend Filter Logic Test</h4>
                    <div class="filter-controls">
                        <label>Severity:</label>
                        <select id="severity-filter">
                            <option value="all">All</option>
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                        <label>Status:</label>
                        <select id="status-filter">
                            <option value="all">All</option>
                            <option value="active">Active</option>
                            <option value="acknowledged">Acknowledged</option>
                            <option value="resolved">Resolved</option>
                        </select>
                        <button class="debug-button" onclick="testFilterLogic()">Test Filter</button>
                    </div>
                    <div id="filtered-alerts" class="alert-list">
                        No alerts loaded
                    </div>
                </div>
                <div>
                    <h4>Raw Alert Data</h4>
                    <div id="raw-alerts" class="alert-list">
                        No alerts loaded
                    </div>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <h3>üìä Current State</h3>
            <div id="current-state">
                <p><strong>Backend Status:</strong> <span id="backend-status">Unknown</span></p>
                <p><strong>Total Alerts:</strong> <span id="total-count">-</span></p>
                <p><strong>Active Alerts:</strong> <span id="active-count">-</span></p>
                <p><strong>Acknowledged Alerts:</strong> <span id="acknowledged-count">-</span></p>
                <p><strong>Resolved Alerts:</strong> <span id="resolved-count">-</span></p>
                <p><strong>Last Action:</strong> <span id="last-action">None</span></p>
            </div>
        </div>

        <div class="debug-section">
            <h3>üìù Debug Logs</h3>
            <div id="log-container" class="log-container">
                <div class="log-entry info">Ready to debug Security Alerts...</div>
            </div>
        </div>
    </div>

    <script>
        // Global state for testing
        let allAlerts = [];
        const FIREBASE_TOKEN = "eyJhbGciOiJSUzI1NiIsImtpZCI6IjJiN2JhZmIyZjEwY2FlMmIxZjA3ZjM4MTZjNTQyMmJlY2NhNWMyMjMiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20veHNjYXJkLWFkZGQ0IiwiYXVkIjoieHNjYXJkLWFkZGQ0IiwiYXV0aF90aW1lIjoxNzU0MjcxOTQwLCJ1c2VyX2lkIjoiRFcxUWJnTFRpQ2dGeE9CYnZQS2RqbEx2SWdvMSIsInN1YiI6IkRXMVFiZ0xUaUNnRnhPQmJ2UEtkamxMdklnbzEiLCJpYXQiOjE3NTQyNzE5NDAsImV4cCI6MTc1NDI3NTU0MCwiZW1haWwiOiJ0c2hlaGxhcEBnbWFpbC5jb20iLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwiZmlyZWJhc2UiOnsiaWRlbnRpdGllcyI6eyJlbWFpbCI6WyJ0c2hlaGxhcEBnbWFpbC5jb20iXX0sInNpZ25faW5fcHJvdmlkZXIiOiJwYXNzd29yZCJ9fQ.M-kYMVIP55TYGVHzN_lW49mMoM1kNHk0i3SAlkbVoCPW0gi8rW2Pc90qijkHwCeyOxNPQShUpqKxzi0bW5Gunab4JvXLnZLiemyVIKlv70is4juUhGqmkZPI-7BiVwFarLhurOn3HqqFMBOYTFyj7BdRaCD6I_pOGvfPBhA9o8mIymPhxSCh75A1LkZXRtypUqyd6Tvm_oiI7UZ1Oduc_Ev3tIHJBuU5py7AtseonA_-qXQWnn5jjKM_TmnNX2geF1SOdOyT6pWqXx52eEAiZ-JAhIdw8yA0ymqpQ9sl-D8PDchI7YcBZQaVI2Cjg95FP_XHnU-BtH82zDvtkVWiIA";
        const API_BASE_URL = "http://localhost:8383";
        const ENTERPRISE_ID = "x-spark-test";

        // Logging function
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '<div class="log-entry info">Logs cleared...</div>';
        }

        function updateState() {
            const activeCount = allAlerts.filter(a => a.status === 'active').length;
            const acknowledgedCount = allAlerts.filter(a => a.status === 'acknowledged').length;
            const resolvedCount = allAlerts.filter(a => a.status === 'resolved').length;

            document.getElementById('total-count').textContent = allAlerts.length;
            document.getElementById('active-count').textContent = activeCount;
            document.getElementById('acknowledged-count').textContent = acknowledgedCount;
            document.getElementById('resolved-count').textContent = resolvedCount;
        }

        function updateLastAction(action) {
            document.getElementById('last-action').textContent = action;
        }

        function displayAlerts(alerts, containerId) {
            const container = document.getElementById(containerId);
            if (alerts.length === 0) {
                container.innerHTML = '<p>No alerts found</p>';
                return;
            }

            container.innerHTML = alerts.map(alert => `
                <div class="alert-item ${alert.status}">
                    <div class="alert-id">${alert.id}</div>
                    <div class="alert-status">Status: ${alert.status} | Severity: ${alert.severity}</div>
                    <div>${alert.title}</div>
                </div>
            `).join('');
        }

        async function testBackendConnection() {
            log('Testing backend connection...', 'info');
            try {
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                log(`Backend health check status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log('Backend is running and healthy', 'success');
                    document.getElementById('backend-status').textContent = 'Connected';
                } else {
                    const errorText = await response.text();
                    log(`Backend health check failed: ${response.status} ${response.statusText}`, 'error');
                    document.getElementById('backend-status').textContent = 'Failed';
                }
            } catch (error) {
                log(`Network error: ${error.message}`, 'error');
                document.getElementById('backend-status').textContent = 'Connection Failed';
            }
        }

        async function fetchAllAlerts() {
            log('Fetching all alerts...', 'info');
            try {
                const url = `${API_BASE_URL}/enterprise/${ENTERPRISE_ID}/security/alerts`;
                log(`Making request to: ${url}`, 'info');
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${FIREBASE_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    allAlerts = data.data.alerts || [];
                    log(`Fetched ${allAlerts.length} alerts`, 'success');
                    log(`Alert statuses: ${allAlerts.map(a => a.status).join(', ')}`, 'info');
                    updateState();
                    displayAlerts(allAlerts, 'raw-alerts');
                    testFilterLogic(); // Auto-test filter logic
                } else {
                    const errorText = await response.text();
                    log(`Error: ${response.status} ${response.statusText}`, 'error');
                    log(`Error details: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`Network error: ${error.message}`, 'error');
            }
        }

        function testFilterLogic() {
            log('Testing frontend filter logic...', 'info');
            
            const severityFilter = document.getElementById('severity-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            
            log(`Filters: Severity=${severityFilter}, Status=${statusFilter}`, 'info');
            
            const filtered = allAlerts.filter(alert => {
                const severityMatch = severityFilter === 'all' || alert.severity === severityFilter;
                const statusMatch = statusFilter === 'all' || alert.status === statusFilter;
                return severityMatch && statusMatch;
            });
            
            log(`Filtered ${filtered.length} alerts from ${allAlerts.length} total`, 'info');
            log(`Filtered alert statuses: ${filtered.map(a => a.status).join(', ')}`, 'info');
            
            displayAlerts(filtered, 'filtered-alerts');
        }

        async function testAcknowledgeFirst() {
            if (allAlerts.length === 0) {
                log('No alerts available to acknowledge', 'warning');
                return;
            }

            const activeAlert = allAlerts.find(a => a.status === 'active');
            if (!activeAlert) {
                log('No active alerts to acknowledge', 'warning');
                return;
            }

            log(`Acknowledging alert: ${activeAlert.id}`, 'info');
            updateLastAction(`Acknowledging alert ${activeAlert.id}`);
            
            try {
                const url = `${API_BASE_URL}/enterprise/${ENTERPRISE_ID}/security/alerts/${activeAlert.id}/acknowledge`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${FIREBASE_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        acknowledgedBy: 'test-user-id',
                        notes: 'Test acknowledgment'
                    })
                });

                log(`Acknowledge response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    log('Alert acknowledged successfully', 'success');
                    updateLastAction(`Alert ${activeAlert.id} acknowledged`);
                    // Refresh alerts
                    await fetchAllAlerts();
                } else {
                    const errorText = await response.text();
                    log(`Acknowledge failed: ${response.status} ${response.statusText}`, 'error');
                    log(`Error details: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`Network error: ${error.message}`, 'error');
            }
        }

        async function testResolveFirst() {
            if (allAlerts.length === 0) {
                log('No alerts available to resolve', 'warning');
                return;
            }

            const activeAlert = allAlerts.find(a => a.status === 'active');
            if (!activeAlert) {
                log('No active alerts to resolve', 'warning');
                return;
            }

            log(`Resolving alert: ${activeAlert.id}`, 'info');
            updateLastAction(`Resolving alert ${activeAlert.id}`);
            
            try {
                const url = `${API_BASE_URL}/enterprise/${ENTERPRISE_ID}/security/alerts/${activeAlert.id}/resolve`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${FIREBASE_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        resolvedBy: 'test-user-id',
                        resolution: 'Test resolution',
                        notes: 'Test resolve through dashboard'
                    })
                });

                log(`Resolve response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    log('Alert resolved successfully', 'success');
                    updateLastAction(`Alert ${activeAlert.id} resolved`);
                    // Refresh alerts
                    await fetchAllAlerts();
                } else {
                    const errorText = await response.text();
                    log(`Resolve failed: ${response.status} ${response.statusText}`, 'error');
                    log(`Error details: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`Network error: ${error.message}`, 'error');
            }
        }

        // Initialize
        log('Security Alerts debug test page loaded', 'success');
        updateState();
    </script>
</body>
</html> 